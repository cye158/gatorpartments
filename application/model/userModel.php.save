<?php
/*
*  This model is used for anything related to Users
*
*
*/
class UserModel {
  function __construct($db) {
    try {
      $this->db = $db;
    } catch (PDOException $e) {
      exit('Database connection could not be established.');
    }
  }

  //Creates a new User account
  //Inserts the arguments into user table in DB
  //The password is hashed and then stored in DB
  public function register($fullName, $phoneNumber, $email, $username, $password, $isLandlord, $isStudent) {
    $sql = "INSERT INTO user (full_name, phone_number, email, username, password, isLandlord, isStudent) VALUES (:fullName, :phoneNumber, :email, :username, :password, :isLandlord, :isStudent)";
    $query = $this->db->prepare($sql);
    $query->bindParam(':fullName', $fullName);
    $query->bindParam(':phoneNumber', $phoneNumber);
    $query->bindParam(':email', $email);
    $query->bindParam(':username', $username);
    
    // hash the password using sha256 and stores into the db
    $password1 = hash('sha256', $password);
    $query->bindParam(':password', $password1);

    $query->bindParam(':isLandlord', $isLandlord);
    $query->bindParam(':isStudent', $isStudent);

    $query->execute();

    header("Location:" . URL . "home/index", true, 401);
    exit();
  }

  //Compares the argument's username and password in DB
  //If matches, we load user info into sessions for persistent data
  public function login($username, $password) {
    $sql = "SELECT * FROM user WHERE username=:username AND password=:password ;";
    $query = $this->db->prepare($sql); 
    $query->bindParam(':username', $username);
    // hash the password using sha256 and compares with the hashed pw in db
    $password1 = hash('sha256', $password);
    $query->bindParam(':password', $password1);
    $query->execute();
    $result = $query->fetch();

    //If the username's and password match, result will have an item.
    //If result is blank, then no match is found.
    if(!$result) {
      //If login fails, we redirect to home and exit() so php does not keep executing.
      $_SESSION['loggedIn'] = false;
      header("Location:" . URL . "home/index", true, 401);
      exit();
    } else {
      // Creates a session to store the users ID, and make them always log in upon visiting the site 
      $_SESSION['userId'] = $result->id;
      $_SESSION['username'] = $result->username;
      $_SESSION['name'] = $result->name;
      $_SESSION['email'] = $result->email;
      $_SESSION['isLandlord'] = $result->isLandlord;
      $_SESSION['isStudent'] = $result->isStudent;
      $_SESSION['loggedIn'] = true;

      // start redirect to page user was at previ
      echo "<meta http-equiv=\"refresh\" content=\"5;url=".$_SERVER['HTTP_REFERER']."\"/>";
      echo "Successfully logged in! Please wait 5s before redirect......";
      }
    }


  //Logs user out of site, killing session cookies
  public function logout() {
    // code obtained from : http://php.net/manual/en/function.session-destroy.php
    // Unset all of the session variables.
    $_SESSION = array();

    // If it's desired to kill the session, also delete the session cookie.
    // Note: This will destroy the session, and not just the session data!
    if (ini_get("session.use_cookies")) {
      $params = session_get_cookie_params();
      setcookie(session_name(), '', time() - 42000,
      $params["path"], $params["domain"],
      $params["secure"], $params["httponly"]);
    }

    // Destroy the session.
    session_destroy();
  }

  public function checkStatus($userId) {
  }

  public function displayMessage($message) {
    echo $message;
    // return $message;
  }

  //Return user's id
  public function getUserId(){
    if(isset($_SESSION['userId'])){
      return $_SESSION['userId'];
    }

    return null;
  }

  public function getUserName(){
    if(isset($_SESSION['userName'])){
      return $_SESSION['userName'];
    }

    return null;
  }

}
?>
